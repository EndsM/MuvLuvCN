## Note

This note will be written in chinese. `English user can refer to git history to see the comments.`

该笔记将用中文进行记录。

## The usage of this note （该笔记的用处）

该笔记用于记录对于一些游戏内容的修改细节、对于中文命名改为英文命名的的记录，以及一些其他需要众人知悉的改动细节。

## The content （内容）

### 2023.11.7

在on_action部分，将“被beta攻陷地区”的效果里，把地区标记为betaland的条目放到了FROM.FROM里面，因为原本的方法使得该效果处于country scope里面。

将common/decision以及其子目录改为了replace的加载方法，因此保证在未来hoi4版本更新时，可以减少对于该部分的修改。

将common/units/equipment这一路径的replace加载方式正确的进行了实装，并且目前将让游戏运行的最低装备文件需求进行了加入，以mod原本的装备属性为最高优先级进行覆盖，理论上和修改前区别是没有的。这一改动的目的是为了在未来对装备进行更多重构或者现代化改修的时候，可以不用担心原版装备的问题。

在特种作战学说这一科技树中，注释掉了submod里面的特殊兵种的加成以减少相关报错，并将相关加成给予了强袭步行攻击机，因此事实上加强了这一海军陆战队等价兵种。

给游戏地图中增加了5个`缺失的港口建筑`的`位置描述`，因此修复了游戏AI功能遍历海军逻辑时，由于该exception而无限循环，导致CPU、GPU、内存占用无限大而最终`内存泄漏`崩溃的问题。

common/scripted_effects路径的加载方式也改为了replace。

删除了名字错误的scripted_gui文件夹，正确名称的保留了。

修复了“超事件”的一些错误，这个也是可能导致崩溃的原因。09c419fb36fba0e3f000cad247902e0fbf4c945f 以及 cc5e278e2ec9306dd5530912c28452d9fa7d9067

游戏开始的betaland在加载后人口恢复的问题，适役人口依旧是0的，但是很明显游戏没有自带修正平民人口的修正，导致在加载后依旧是以state历史为准的。

这一问题不适宜使用修改state历史的方式解决，可以在beta事件1里面对人口进行削减，这个可以之后进行测试。

### 2023.11.8

今天先从简单的开始处理，开始把国家精神部分的中文命名改为英文命名，并且添加相应的localization，注意，这一改动必定会导致旧有存档无效。（暂未开始执行）

在14:25 UTC-8时遇到了新的崩溃问题，这次有两个怀疑对象，1. ai策略部分很多遗失了取消条件的策略。2.on_action部分还在触发原版的很多东西，但是这些东西在mod里面缺失对应的地址，可能引发空地址问题。

根据崩溃时的行为是“ping_client”，认为依旧是和AI相关的错误，目前没有在log里面看到有直接崩溃风险的部分，但是目前的怀疑目标为：ai_templates。

再次修补了昨天添加的港口位置，这里列出有问题的省份ID：8913、11960、13226、13228、13230

### 2023.11.9

今天一开始，首先修复了经济法案中战争总动员的判断声明放错地方的问题。

然后就是接下来要开始动手修改命名问题了，这一点是必定破坏存档兼容性的，所以从这里先记一下。

国联分担协议修正案这个精神可以考虑之后，删除各国的分别的精神，然后移动到uni下面的一个通用精神。

已完成非洲的idea文件里面的，中文命名改为英文命名的工作。

### 2023.11.10

首先给美国写个AI国策选取树，目前太喜欢点那些没用的东西了。右边那坨国策回头既可以改名，也可以直接删掉，重新写成美国的全球援助线和门罗主义的二选一。

AI国策组写好了，理论上让美国变强了10倍甚至9倍，强而有力啊强而有力。

回头要解决一下BETA把全球的光线级都调到东南亚的问题，我觉得大东亚联合再怎么顶也顶不住这个。

scripted_enums和equipment_groups需要回头重构一下。

### 2023.11.11

暂时把战略研究会这里，用society-社团的翻译来进行了。

修复了一个国策上的问题，回头把国策的部分都改成ID法，来符合最新的P社模组规范。

另外就是苏联等的绝大多数的顾问都是处于半失效或完全失效状态。

国家精神名称修改已经进行到比较多的程度了。

以后可以把现有将领添加部长和总司令职务。

### 2023.11.12

重置了拉格朗日计划，也就是Alternative 5系列决议，这样子现在应该是正常运行了，并且中文命名也是修改成了英文命名。

到这条笔记为止，还没有完成ideas的英文命名法收尾工作，不过预计今天可以完成这一工作。

修复美国的两个太空计划分支的决议无法显示的问题，等于巨大加强美国以及抗BETA的AI势力本身。但是曙光计划的决议还没修，回头再修。

Ideas的命名修改完成了。顺便拉格朗日计划现在是正常运作的任务形式的决议了。

### 2023.11.13

修改了国策树的id命名规则，其中BETA巢穴使用各自地区的名称作为开头，其他国家采用TAG_focus_tree的ID命名方式。

开始将国策中添加装备的条目，改成标准的有无DLC情况下分别添加的方式，这样子算是有一些适配性。

同时删除掉可忽略的条目，即有没有都一样的情况。

新增了一个parties翻译文件，来储存风味型的党派名称文本内容。

稍微维修了一个旧的TSF科技树中的bug。

目前完成了首字母A-E的国策树的错误清理工作，包括其中的装备添加方法的修改。

给电磁炮系列专门加了个新的category叫做MVLV_railgun_tech，方便给加成卡。

除此之外添加了MVLV_tsf_module_tech，用以表示战术机模块，用来方便未来增加相应的研究速度修正，或者加成卡。

完成了美国的国策命名更改，至此已经完成一个阶段的修正工作，开始将版本提升到下一个版本中。

### 2023.11.14

开始进行大清洗，即清理掉那些来自原版的无用顾问，他们并没有成功在加载mod后的游戏中生效。

修复了三张战术卡，其中轨道降下战术卡限定用于空降巢穴，在巢穴战斗时提升攻击方攻击。

另外两张分别是人类和BETA在巢穴中战斗的战术卡，这两张都是对人类的纯削弱。

停止修复TSFcommander特质，原因是后面扯到的东西有点多，可能还需要改变为替换原版文件的情况。原理是，有问题导致无法添加新的可指定特质，任何新的可指定特质都会导致无限循环而最终泄露。

之后逐步排查可能卡住AI的地方可能会有用，参见目前还十分巨大的error log里面no game data的部分，这些有的会导致AI问题。

### 2023.11.15

新建一个分支，在这里进行trait test的活动。

合并了该分支，并且以后将会让git自动改变txt文件的EOL到LF，这样子可以减少因为EOL导致的P社启动器bug，不过效果还需要持续观察。希望目前的力度足够防止EOL导致的加载不全的问题。

使用modifier_army_sub_unit_category_MVLV_tsf_系列可以给被定义为tsf的categories，而不是group的部队加成。

不是那些AI定义有问题，是整个地图出了问题，这不是回滚AI修改就一定可以修复的，需要重新处理地图定义，这个之后处理。

具体细节是：加载到游戏里的版本的地图，所有大洲的定义是失效的，怀疑某个版本新加了大洲，或者其他原因导致了游戏不读取整个地图的省份的大洲定义。

### 2023.11.19

开始着手制作统计和大战结束时结束游戏的功能，该功能将会统计两侧的伤亡数据，以及游戏日期时长。

根据Debug证明，casualties在一个国家陷入投降之后并不会被清空，统计的清空还是不确定是为什么的，因此的想法是，给每个国家提供一个buffed casualties变量，在国家投降时，将其当前casualties加入到该侧总casualties之中，然后将数值存到buffed casualties之中。

该国家每次投降，会检查是否有buffed casualties存在，如果不存在正常计算伤亡，存在的情况下将目前伤亡减去buffed casualties加入到总伤亡中，然后buffed casualties设为目前的casualties。
